# Interoperability Specification

The interoperability specification is defined using the [OpenAPI Specification](https://swagger.io/specification/) (formerly called Swagger) with associated test runner to validate the specification behavior against conforming implementations of the spec.

## Interoperability Profiles

Each UPP-compliance application need only implement the profiles that it needs to support.  Each profile represents a distinct service unit that acts as a building block of the peer-based, distributed UPP system.

## Permit Issuer

A permit issues has the authority to approve or deny OSOW permits.

### Scopes

A Permit Issuer MUST implment the following scopes

* `permit.issuer.<authority>` where `<authority>` is the unique UPP-defined authority string.

## UPP Scopes

A scope defines am API that CAN be implemented independently of any other scope and provide a complete Unit of Service to UPP client applications.

### `permit.issuer.<authority>`

This scope defines the API that a permit authority must implement in order to provide permits through its jurisdiction to UPP clients.

#### GET `{base}/info`

Returns a [Permit Issuer Metadata](#Permit-Issuer-Metadata) record to the client.  This endpoint MAY be secured but is not REQUIRED to be.

#### POST `{base}/permits`

Returns a [Permit Request Response](#Permit-Issuer-Metadata) record to the client. This endpoint MUST be secured and validate that the request comes from a trusted UPP system. The user making the request MUST have the `hauler` claim.

The `receipt` field is an opaque string generated by the permitting system.  The field SHOULD be less than 200 characters in length and is recommended that a [UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier) or similar data type be used. The permit issuer MUST be able to retrive a permit record if it is provided with a valid receipt in the future.

#### GET `{base}/permits

Return a list of [Permit Records](#Permit-Record) filtered by the identified user. This endpoint MUST be secured and MUST filter permits be recognizing the following user claims

* The `hauler` claim SHOULD allow the user to retrieve all of permits that have been issues to this user.  The user SHALL be identified by the contents of an `email` claim, an IdP token or a combination of the two. The implementing system DOES NOT need to return all permits in a single transaction, but MAY provide pagination via a `_links` JSON subrecord that follows the [HAL](http://stateless.co/hal_specification.html) specification.

* The `dps` claim MAY grant the user the ability to view ALL permits issued by the permit authority.

#### GET `{base}/permits/{receipt}

Return a single [Permit Record](#Permit-Record) identified by the `receipt`. This endpoint MUST be secured and the permit authority MUST verify that the passed identity has access to the permit associated with the receipt.

## UPP Authorities

An `authority` in UPP is an independent entity.  Cities, Counties and the State are authorities.  Private companies will not be authorities themselved, but may exposed services that implement specific API scopes on behalf of authorities.

| Authority Identifier | Authority Name |
| - | - |
| `stlouis_co_mn` | St. Louis County |
| `duluth_ci_mn` | City of Duluth |
| `dps_mn` | Minnesota Department of Public Safety |
| `dvs_mn` | Minnesota Driver and Vehicle Services |

## UPP Claims

The following claims are recognized by the UPP systems

| Claim | Description |
| - | - |
| `email` | One or more email addresses
| `hauler` | User is a hauler and generally entitled to interact with the systems in pursuit of obtaining a OSOW permit.
| `dps` | Department of Public Safety Claim.  Value MAY be a list of specific roles the users holds within DPS, e.g. 'hwp'

## UPP Records

### Permit Issuer Metadata

```JSON
{
    "authority": string    
}
```

### Permit Request Response

```JSON
{
    "authority": string,
    "timestamp": int64,
    "status": "approved" | "denied" | "no_authority" | "under_review",
    "receipt": string
}
